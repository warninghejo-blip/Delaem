# Оптимизация для множества пользователей

## Проблема
Каждый пользователь запрашивает свой уникальный адрес, поэтому кэширование по адресу не помогает при множестве пользователей.

## Решения

### 1. ✅ Увеличены задержки между запросами
- **Было**: 2000ms (0.5 req/s)
- **Стало**: 4000ms (0.25 req/s)
- **Эффект**: В 2 раза меньше запросов к UniSat API

### 2. ✅ Увеличен кэш для общих данных
- **Цены (get_prices)**: Кэшируются 5 минут для ВСЕХ пользователей
  - BTC, FB, FENNEC цены одинаковы для всех
  - Один запрос к API → кэш на 5 минут → все пользователи получают из кэша
- **Балансы и метаданные**: 60 секунд (было 30)
  - Даже если адреса разные, кэш снижает нагрузку

### 3. ✅ Улучшено кэширование цен
- Цены кэшируются с фиксированным ключом для всех пользователей
- Cloudflare Edge Cache: 5 минут
- Browser Cache: 1 минута

### 4. ✅ Увеличен Cloudflare Cache для fractal_audit
- **s-maxage**: 300 секунд (5 минут)
- **max-age**: 60 секунд (1 минута)
- Даже если адреса разные, кэш снижает нагрузку на API

## Математика

### Сценарий: 100 пользователей одновременно

**Без оптимизации:**
- 100 запросов к UniSat API
- Throttling 2000ms = 0.5 req/s
- Время: 200 секунд (3.3 минуты)

**С оптимизацией:**
- Задержки 4000ms = 0.25 req/s
- Кэш цен: 1 запрос вместо 100
- Кэш балансов: если адреса повторяются, меньше запросов
- Время: меньше благодаря кэшу

### Для цен (одинаковы для всех):
- **Без кэша**: 100 запросов к CMC/InSwap
- **С кэшем**: 1 запрос к CMC/InSwap (кэш 5 минут)
- **Экономия**: 99% запросов

## Результат

✅ **Меньше 429 ошибок**:
- Увеличенные задержки (4000ms)
- Кэш для общих данных (цены)
- Увеличенный кэш для балансов

✅ **Быстрее ответы**:
- Цены из кэша (5 минут)
- Балансы из кэша (60 секунд)

✅ **Масштабируемость**:
- Кэш цен работает для всех пользователей
- Увеличенные задержки снижают нагрузку
- Cloudflare Edge Cache распределяет нагрузку

## Дополнительные рекомендации

1. **Использовать API key UniSat** (если доступен) - улучшает лимиты
2. **Мониторинг 429 ошибок** - отслеживать частоту
3. **Fallback источники** - если UniSat недоступен
4. **Очередь запросов** - если нужно, можно добавить очередь

